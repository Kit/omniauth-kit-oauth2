#!/usr/bin/env bash

# Checks if a new version of a gem has been declared and publishes the new version to Gemfury.
#
# Parameters:
# - Requires path to a .gemspec as an argument
# - Requires $GEMFURY_API_TOKEN to be set
# - Requires $GEMFURY_SOURCE to be set, e.g. https://xxx@repo.fury.io/convertkit/
# - Optionally set $GEMFURY_ACCOUNT to change publishing account
#
# Usage:
#     $ export GEMFURY_API_TOKEN="xxx"
#     $ export GEMFURY_SOURCE="xxx"
#     $ bin/publish_gem "omniauth-kit-oauth2.gemspec"

set -e

GEM_SPEC="$1"
GEM_NAME="$(echo $GEM_SPEC | cut -d '.' -f 1)"
GEMFURY_ACCOUNT="${GEMFURY_ACCOUNT:-convertkit}"

if [[ ! -f "$GEM_SPEC" ]]; then
  echo "🚨  Provided gemspec is invalid, file not found: $GEM_SPEC"
  exit 1
fi

echo "🔍  Checking if \"$GEM_SPEC\" has a new version...";

# Add gemfury to sources so `gem list` finds latest gem version
gem sources --silent --add "$GEMFURY_SOURCE"

latest_version=$(gem list "$GEM_NAME" --remote --exact | tail | awk '{print $2}' | sed -E 's/\(|\)//g')
current_version=$(echo "require 'rubygems'; puts Gem::Specification::load(\"$GEM_SPEC\").version" | ruby)
highest_version=$(printf "%s\n" "$latest_version" "$current_version" | sort -V | tail -1)

if [[ "$current_version" != "$latest_version" && "$current_version" == "$highest_version" ]]; then
  new_gem_version="$GEM_NAME-$current_version"

  echo "👷  New version detected, publishing \"$new_gem_version\"...";

  if ! command -v fury &> /dev/null; then
    echo "🔧  Installing Gemfury CLI...";
    echo "deb [trusted=yes] https://apt.fury.io/cli/ * *" | sudo tee -a /etc/apt/sources.list.d/fury-cli.list
    sudo apt-get update
    sudo apt-get install -y fury-cli
  fi

  echo "🔩  $(fury --version)"

  echo "📦  Building gem artifact...";
  gem build "$GEM_SPEC"

  echo "🚚  Uploading gem artifact...";
  fury push "$new_gem_version.gem" --account "$GEMFURY_ACCOUNT" --api-token "$GEMFURY_API_TOKEN"

  echo "✅  $new_gem_version published!";
else
  echo "💅  No new version detected, latest version is \"$latest_version\".";
fi
